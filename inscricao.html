<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buscar cadastro por CPF</title>
  <style>
    :root{
      --primary:#4a6cf7;
      --bg:#f5f7fb;
      --card:#fff;
      --text:#222;
      --muted:#666;
      --radius:12px;
      --font: "Inter", "Segoe UI", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:linear-gradient(180deg,#f5f7fb 0%, #eef2ff 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .card{
      width:100%;
      max-width:760px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(22,44,120,0.08);
      padding:26px;
    }
    h1{margin:0 0 6px 0; color:var(--primary); font-size:1.5rem}
    p.lead{margin:0 0 18px 0; color:var(--muted)}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    input[type="text"]{
      flex:1 1 220px;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid #e6e9f2;
      font-size:1rem;
    }
    button{
      background:var(--primary);
      color:white;
      border:none;
      padding:12px 16px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }
    button:active{transform:translateY(1px)}
    .result{
      margin-top:18px;
      padding:16px;
      border-radius:10px;
      background:#fbfdff;
      border:1px dashed #e6eefc;
    }
    .error{color:#b00020; font-weight:600}
    .nome{font-size:1.25rem; font-weight:700; margin-bottom:6px}
    .sub{color:var(--muted)}
    @media (max-width:520px){
      .row{flex-direction:column}
      button{width:100%}
    }
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="titulo">
    <h1 id="titulo">Acessar Cadastro por CPF</h1>
    <p class="lead">Digite seu CPF (somente n√∫meros ou com pontos/tra√ßo) para ver seu cadastro.</p>

    <div class="row" style="align-items:center">
      <input id="cpfInput" type="text" placeholder="Ex.: 123.456.789-00 ou 12345678900" inputmode="numeric" />
      <button id="btnBuscar" onclick="buscar()">üîé Buscar</button>
    </div>

    <div id="status" class="result" style="display:none;"></div>

    <p style="margin-top:12px; color:var(--muted); font-size:0.9rem">
      Observa√ß√£o: se a planilha tiver coluna <em>Sexo</em> / <em>G√™nero</em>, usaremos ela para definir "Bem Vindo(a)". Caso contr√°rio, aplicamos uma heur√≠stica simples no primeiro nome (nomes terminados em <strong>'a'</strong> ‚Üí feminino). A heur√≠stica pode errar para alguns nomes.
    </p>
  </div>

  <script>
    // URL do OpenSheet (planilha p√∫blica em leitura)
    const SHEET_URL = "https://opensheet.elk.sh/1KbxCvGFkf1dgyrxx-BHkutNN8ANztGKDiCJ0GhrwCK4/P√°gina1";

    // normaliza CPF: remove tudo que n√£o for d√≠gito
    function normalizeCPF(cpf) {
      return (cpf || "").toString().replace(/\D/g, "");
    }

    // heur√≠stica simples para detectar g√™nero pelo primeiro nome
    function guessGenderFromName(nomeCompleto) {
      if (!nomeCompleto) return null;
      const first = nomeCompleto.trim().split(/\s+/)[0] || "";
      const lastChar = first.slice(-1).toLowerCase();
      // regra simples: nomes terminados em 'a' => feminino; termina√ß√µes comuns 'o' => masculino
      if (lastChar === "a") return "F";
      if (lastChar === "o") return "M";
      // fallback neutro assume masculino (menos prov√°vel de errar em PT, mas n√£o garantido)
      return "M";
    }

    // tenta extrair g√™nero a partir de uma linha (obj): procura colunas poss√≠veis
    function detectGenderFromRow(rowObj) {
      const keys = Object.keys(rowObj || {});
      const genderKeys = keys.filter(k => /^(sexo|genero|g√©nero|gender)$/i.test(k));
      for (const k of genderKeys) {
        const v = (rowObj[k] || "").toString().trim().toLowerCase();
        if (!v) continue;
        if (v.startsWith("m")) return "M";
        if (v.startsWith("f")) return "F";
        // aceitar "masculino", "feminino", "m", "f", etc.
      }
      return null;
    }

    // formata nome (NomeCompleto) para exibi√ß√£o (retira espa√ßos extras)
    function formatName(nome) {
      if (!nome) return "";
      return nome.trim().replace(/\s+/g, " ");
    }

    async function buscar() {
      const statusEl = document.getElementById("status");
      statusEl.style.display = "block";
      statusEl.innerHTML = "Buscando...";

      const cpfRaw = document.getElementById("cpfInput").value;
      const cpf = normalizeCPF(cpfRaw);

      if (!cpf || cpf.length < 8) {
        statusEl.innerHTML = `<div class="error">CPF inv√°lido. Digite o CPF corretamente.</div>`;
        return;
      }

      try {
        const resp = await fetch(SHEET_URL, {cache: "no-store"});
        if (!resp.ok) {
          statusEl.innerHTML = `<div class="error">Erro ao acessar a planilha (status ${resp.status}).</div>`;
          return;
        }

        const dados = await resp.json();
        if (!Array.isArray(dados) || dados.length === 0) {
          statusEl.innerHTML = `<div class="error">Nenhum dado encontrado na planilha.</div>`;
          return;
        }

        // procurar correspond√™ncia de CPF: vamos normalizar os CPFs da planilha tamb√©m
        const encontrado = dados.find(row => {
          // poss√≠veis nomes de coluna que armazenam CPF: "CPF", "Cpf", "cpf"
          // procuramos qualquer campo cujo valor, sem n√£o-d√≠gitos, case-insensitive, bata com o cpf fornecido
          return Object.values(row).some(val => {
            if (val === null || val === undefined) return false;
            const v = String(val);
            const vDigits = v.replace(/\D/g, "");
            return vDigits === cpf;
          });
        });

        if (!encontrado) {
          statusEl.innerHTML = `<div class="error">CPF n√£o encontrado. Verifique e tente novamente.</div>`;
          return;
        }

        // pega nome: procura por chaves comuns
        const nomeChaves = ["NomeCompleto","Nome","nomeCompleto","nome","FullName","Nome completo"];
        let nome = "";
        for (const k of nomeChaves) {
          if (encontrado[k]) { nome = encontrado[k]; break; }
          // tamb√©m tentar key insens√≠vel
          const keyLower = Object.keys(encontrado).find(x => x.toLowerCase() === k.toLowerCase());
          if (keyLower) { nome = encontrado[keyLower]; break; }
        }
        nome = formatName(nome || encontrado[Object.keys(encontrado)[0]] || "");

        // detecta genero
        let genero = detectGenderFromRow(encontrado);
        if (!genero) {
          genero = guessGenderFromName(nome); // heur√≠stica
        }

        // montar sauda√ß√£o
        const saudacao = genero === "F" ? "Seja Bem Vinda" : "Seja Bem Vindo";
        // se quiser adicionar (a) automaticamente: "Seja Bem Vind(o/a)" ‚Äî aqui usamos o correto conforme g√™nero detectado

        // exibir resultado
        const html = `
          <div class="nome">Ol√°, ${nome} ‚Äî <span style="color:var(--primary)">${saudacao}!</span></div>
          <div class="sub"><strong>CPF:</strong> ${cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4")}</div>
          <div style="margin-top:10px;">
            <strong>Informa√ß√µes encontradas na planilha:</strong>
            <pre style="white-space:pre-wrap;margin:8px 0 0 0;background:#fcfdff;padding:10px;border-radius:8px;border:1px solid #eef6ff;">
${Object.entries(encontrado).map(([k,v]) => `${k}: ${v}`).join("\n")}
            </pre>
          </div>
        `;
        statusEl.innerHTML = html;

      } catch (err) {
        console.error(err);
        statusEl.innerHTML = `<div class="error">Erro ao buscar dados: ${err.message || err}</div>`;
      }
    }
  </script>
</body>
</html>
