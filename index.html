<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Ficha de Cadastros e Anamnese</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
    h2, h3 { color: #333; }
    form {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 5px #ccc;
    }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin-top: 5px;
      border: 1px solid #ccc; border-radius: 4px;
      box-sizing: border-box; font-size: 14px;
    }
    textarea { resize: vertical; min-height: 60px; }
    button {
      background: #007bff; color: white; cursor: pointer;
      border: none; margin-top: 20px;
    }
    button:hover { background: #0056b3; }
    #mensagem {
      margin-top: 15px; padding: 10px; border-radius: 4px;
    }
    .sucesso { color: green; background: #d4edda; border: 1px solid #c3e6cb; }
    .erro { color: #721c24; background: #f8d7da; border: 1px solid #f5c6cb; }
    .carregando { color: #856404; background: #fff3cd; border: 1px solid #ffeaa7; }
    .checkbox-text {
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 5px;
      font-size: 13px;
      margin-top: 10px;
      white-space: pre-line;
    }
    .checkbox-line {
      margin-top: 10px;
      font-weight: normal;
      display: flex;
      align-items: center;
    }
    .checkbox-line input {
      width: auto;
      margin-right: 8px;
    }
    hr {
      margin: 30px 0;
      border: none;
      border-top: 1px solid #ddd;
    }
    @media (max-width: 600px) {
      body { margin: 10px; }
      form { padding: 15px; }
    }
  </style>
</head>

<body>
  <h2>Cadastro e Ficha de Anamnese</h2>

  <form id="formCadastro">
    <h3>Informações Cadastrais</h3>

    <label for="email">E-mail</label>
    <input type="email" id="email" name="email" required>

    <label for="nome">Nome Completo</label>
    <input type="text" id="nome" name="nome" required>

    <label for="cpf">CPF</label>
    <input type="text" id="cpf" name="cpf" maxlength="14" placeholder="000.000.000-00" required>

    <label for="rg">RG</label>
    <input type="text" id="rg" name="rg">

    <label for="localNascimento">Local de Nascimento (Cidade e Estado)</label>
    <input type="text" id="localNascimento" name="localNascimento">

    <label for="dataNascimento">Data de Nascimento</label>
    <input type="date" id="dataNascimento" name="dataNascimento">

    <label for="telefone">WhatsApp com DDD</label>
    <input type="text" id="telefone" name="telefone" required>

    <label for="endereco">Endereço (rua, bairro, número e complemento)</label>
    <input type="text" id="endereco" name="endereco">

    <hr>

    <h3>Ficha de Anamnese</h3>

    <label>1 - Já consagrou a Medicina Ayahuasca?</label>
    <div>
      <label><input type="radio" name="ayahuasca" value="Não" required> Não</label>
      <label><input type="radio" name="ayahuasca" value="Uma vez"> Uma vez</label>
      <label><input type="radio" name="ayahuasca" value="Mais de 5 vezes"> Mais de 5 vezes</label>
    </div>

    <label>2 - Fale um pouco da sua intenção ao vir à cerimônia:</label>
    <textarea id="intencao" name="intencao"></textarea>

    <label>3 - Estado civil ou convivência:</label>
    <input type="text" id="estadoCivil" name="estadoCivil">

    <label>4 - Alguma questão de saúde a deixar registrado para nós?</label>
    <textarea id="saude" name="saude"></textarea>

    <label>5 - Você é ou já foi dependente de alguma substância química?</label>
    <textarea id="dependencia" name="dependencia"></textarea>

    <label>6 - A cerimônia tem vagas limitadas...</label>
    <div class="checkbox-text">
      A cerimônia tem vagas limitadas, a ordem dos participantes é feita por ordem de inscrição. 
      Fico ciente que se não entrei, estou na lista de espera.
    </div>
    <div class="checkbox-line">
      <input type="checkbox" id="cienteVagas" name="cienteVagas" required> 
      <label for="cienteVagas">Ciente</label>
    </div>

    <label>7 - Termo de Responsabilidade</label>
    <div class="checkbox-text">
      Venho de livre e espontânea vontade solicitar o ingresso à sessão com Ayahuasca no Instituto Xamânico Mistérios da Jibóia.
      Declaro que estou ciente da natureza desses trabalhos, da preparação exigida, dos detalhes do ritual e da condição expressa
      de permanecer no local até o fechamento dos trabalhos. Também estou ciente da proibição de portar ou usar quaisquer
      substâncias proscritas pela lei penal brasileira, bebidas alcoólicas, armas brancas ou de fogo.
      Comprometo-me a obedecer a todas as determinações do dirigente dos trabalhos.
      No local, antes do início do ritual, estou ciente de que preencherei uma ficha de anamnese detalhada.

      Referente ao meu histórico de saúde, atesto que:
      • Não possuo restrição médica para participação.
      • Não fui diagnosticado(a) com qualquer distúrbio psicológico ou psiquiátrico.
      • Não sou portador(a) de esquizofrenia ou apresentei qualquer episódio esquizoide.
      • Nunca fui internado(a) em nenhuma instituição psiquiátrica.
      • Não fui diagnosticado(a) como autista ou portador de síndrome de Asperger.
      • Não sou portador(a) de imunodeficiência ou de doença preexistente crônica ou grave.
      • Não faço abuso de nenhum tipo de substância que cause dependência química.
      • Não estou em tratamento com drogas de tarja preta e/ou descritas.
      • Não pratico automedicação.
      • Não tomei vacina de qualquer tipo nos últimos 20 dias.
    </div>
    <div class="checkbox-line">
      <input type="checkbox" id="termoResponsabilidade" name="termoResponsabilidade" required> 
      <label for="termoResponsabilidade">Ciente</label>
    </div>

    <label>8 - Autorização de uso dos meus dados</label>
    <div class="checkbox-text">
      Estou ciente e autorizo o uso dos meus dados para que o Instituto entre em contato comigo sobre as cerimônias e atividades oferecidas.
      Meus dados serão tratados com sigilo e usados apenas para fins relacionados. Lembro que posso solicitar a exclusão da lista a qualquer momento.
    </div>
    <div class="checkbox-line">
      <input type="checkbox" id="usoDados" name="usoDados" required> 
      <label for="usoDados">Ciente</label>
    </div>

    <label>9 - Termo de Cancelamento e Política de Devolução</label>
    <div class="checkbox-text">
      Ao confirmar sua inscrição na cerimônia, o participante declara estar ciente e de acordo com a política de cancelamento e devolução descrita abaixo:
      Após a confirmação da inscrição e realização do pagamento, não haverá devolução de valores sob nenhuma circunstância,
      inclusive em casos de desistência ou impossibilidade de comparecimento.
      No entanto, oferecemos a possibilidade de utilizar o valor pago como crédito para uma próxima cerimônia, desde que:
      - O aviso seja feito com antecedência mínima de 48h antes do evento;
      - Seja realizada uma solicitação formal de remarcação (por WhatsApp ou e-mail);
      - Haja disponibilidade de vagas na nova data;
      - O crédito seja utilizado em até 3 meses após a data original;
      - O crédito é intransferível e pessoal.
      ⚠ Em casos de desistência no dia da cerimônia ou durante sua realização, não haverá reembolso ou crédito.
    </div>
    <div class="checkbox-line">
      <input type="checkbox" id="politicaCancelamento" name="politicaCancelamento" required> 
      <label for="politicaCancelamento">Ciente</label>
    </div>

    <label>Declaração Final</label>
    <div class="checkbox-text">
      Ao enviar este formulário, declaro que as informações fornecidas são verdadeiras e completas, que foram preenchidas por mim,
      e que fui informado(a) sobre os aspectos legais e de saúde envolvidos na cerimônia. Entendo que o Instituto segue práticas
      seguras e não se responsabiliza por quaisquer complicações que possam surgir devido a condições de saúde não declaradas ou desconhecidas.
    </div>
    <div class="checkbox-line">
      <input type="checkbox" id="declaracaoFinal" name="declaracaoFinal" required> 
      <label for="declaracaoFinal">Ciente</label>
    </div>

    <button type="submit">Enviar Cadastro</button>
  </form>

  <div id="mensagem"></div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwHTaZXuaK9XRuy7WLsXlYiF_XasL5e5sQFGdOksa1wpHA3rUbJ16cEUZH5-q12jHruTQ/exec";

    document.getElementById("formCadastro").addEventListener("submit", async (e) => {
      e.preventDefault();

      const mensagemDiv = document.getElementById("mensagem");
      mensagemDiv.textContent = "Verificando duplicidade...";
      mensagemDiv.className = "carregando";

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;

      // Obtém o CPF e adiciona o apóstrofe para garantir que seja tratado como texto
      let cpf = document.getElementById("cpf").value.trim();
      cpf = "'" + cpf; // Adiciona apóstrofe no CPF para tratá-lo como texto

      try {
        // Verifica se o CPF já existe no sistema (via Apps Script)
        const check = await fetch(`${scriptURL}?cpf=${encodeURIComponent(cpf)}`);
        const duplicado = await check.text();

        if (duplicado.includes("DUPLICADO")) {
          mensagemDiv.textContent = "⚠️ Já existe um cadastro com este CPF.";
          mensagemDiv.className = "erro";
          btn.disabled = false;
          return;
        }

        mensagemDiv.textContent = "Enviando dados...";
        mensagemDiv.className = "carregando";

        // Cria o FormData com o CPF modificado
        const formData = new FormData(e.target);
        formData.set("cpf", cpf); // Substitui o CPF no FormData com a versão corrigida

        // Envia o formulário para o Apps Script
        const resposta = await fetch(scriptURL, { method: "POST", body: formData });
        const resultado = await resposta.text();

        if (resposta.ok) {
          mensagemDiv.textContent = "✓ " + resultado;
          mensagemDiv.className = "sucesso";
          e.target.reset();
        } else {
          throw new Error(resultado || "Erro na requisição");
        }
      } catch (err) {
        mensagemDiv.textContent = "❌ Erro: " + err.message;
        mensagemDiv.className = "erro";
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>